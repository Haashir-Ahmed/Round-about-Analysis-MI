import pandas as pd
import geopandas as gpd
# Load results
inter_results = pd.read_csv(r"C:\Users\haash\Downloads\SimilarIntersections1.csv")

# Convert to GeoDataFrames
inter_gdf = gpd.GeoDataFrame(
    inter_results,
    geometry=gpd.points_from_xy(inter_results.lon, inter_results.lat),
    crs="EPSG:4326"
).to_crs("EPSG:32617")


# Find intersections within 150m and keep only highest AADTR (FAST VERSION)
inter_gdf = inter_gdf.sort_values('AADTR_mean', ascending=False).reset_index(drop=True)

keep_mask = [True] * len(inter_gdf)
sindex = inter_gdf.sindex

for i in range(len(inter_gdf)):
    if not keep_mask[i]:
        continue
    
    # Find candidates within 150m using spatial index
    buffer = inter_gdf.loc[i, 'geometry'].buffer(150)
    possible_matches = list(sindex.intersection(buffer.bounds))
    
    # Check actual distances for candidates
    for j in possible_matches:
        if j > i and keep_mask[j]:  # Only check later rows (higher index = lower AADTR due to sort)
            dist = inter_gdf.loc[i, 'geometry'].distance(inter_gdf.loc[j, 'geometry'])
            if dist <= 150:
                keep_mask[j] = False  # Remove lower AADTR intersection

# Keep only the selected intersections
inter_cleaned = inter_gdf[keep_mask].copy()


# Convert back to lat/lon for saving
inter_cleaned = inter_cleaned.to_crs("EPSG:4326")
inter_cleaned['lat'] = inter_cleaned.geometry.y
inter_cleaned['lon'] = inter_cleaned.geometry.x

# Drop geometry column and save
inter_cleaned_df = pd.DataFrame(inter_cleaned.drop(columns='geometry'))

output_dir = r"C:\Users\haash\Downloads"
inter_cleaned_df.to_csv(
    f"{output_dir}\\SimilarIntersections_Cleaned.csv",
    index=False
)

print(f"\nCleaned results saved to: {output_dir}\\SimilarIntersections_Cleaned.csv")
